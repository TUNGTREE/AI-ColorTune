# ColorTune 项目架构

## 目录结构总览

```
colortune/
├── backend/          ← FastAPI 后端 (Python)
│   ├── app/
│   │   ├── main.py              # 应用入口
│   │   ├── config.py            # 配置管理
│   │   ├── database.py          # 数据库连接
│   │   ├── core/                # 核心模块
│   │   │   ├── color_params.py  # 调色参数标准模型
│   │   │   ├── image_ops.py     # 16 种图像调整算法
│   │   │   └── prompts.py       # AI 提示词模板
│   │   ├── models/              # SQLAlchemy 数据模型
│   │   │   ├── user.py
│   │   │   ├── style.py
│   │   │   └── grading.py
│   │   ├── schemas/             # Pydantic 请求/响应模型
│   │   │   ├── style.py
│   │   │   └── grading.py
│   │   ├── api/                 # API 路由
│   │   │   ├── upload.py
│   │   │   ├── ai_config.py
│   │   │   ├── style.py
│   │   │   └── grading.py
│   │   └── services/            # 业务逻辑
│   │       ├── ai_provider.py
│   │       ├── style_service.py
│   │       ├── grading_service.py
│   │       └── image_processor.py
│   ├── tests/                   # 测试 (101 个)
│   ├── requirements.txt
│   └── pytest.ini
├── frontend/         ← React 前端 (TypeScript)
│   └── src/
│       ├── App.tsx              # 主应用 + 4 步导航
│       ├── api/index.ts         # Axios API 客户端
│       ├── stores/appStore.ts   # Zustand 全局状态
│       ├── types/index.ts       # TypeScript 类型定义
│       ├── components/
│       │   ├── StyleDiscovery/       # 步骤 0: 风格发现
│       │   ├── GradingSuggestion/    # 步骤 1: 调色建议 + Before/After
│       │   ├── FineTune/             # 步骤 2: 参数微调
│       │   └── Export/               # 步骤 3: 导出
│       ├── hooks/
│       │   └── useDebouncedCallback.ts
│       └── utils/
│           └── canvasPreview.ts      # CSS Filter 实时预览引擎
├── uploads/          ← 用户上传的原始图片
├── previews/         ← 调色预览图缓存 (800px 缩略图)
└── exports/          ← 全分辨率导出文件 (JPEG/PNG/TIFF)
```

---

## 核心数据流

```
用户上传照片
    ↓
[步骤0] StyleDiscovery ──→ AI 分析场景 → 生成 4 种风格 → 用户选择
    ↓ (重复 3+ 轮)
    ↓ AI 汇总选择 → 生成用户风格档案 (UserStyleProfile)
    ↓
[步骤1] GradingSuggestion ──→ AI 结合档案+新照片 → 生成 3 个调色建议(含预览)
    ↓ 用户选择一个建议
    ↓
[步骤2] FineTune ──→ 滑块微调参数 → CSS 实时预览 + 服务端精确预览(500ms 防抖)
    ↓
[步骤3] Export ──→ 全分辨率应用调色 → 下载 JPEG/PNG/TIFF
```

---

## 后端各文件详解

### 入口与配置

| 文件 | 作用 |
|------|------|
| `app/main.py` | FastAPI 应用入口。注册 4 个路由器、CORS 中间件、静态文件挂载 (`/uploads`, `/previews`, `/exports`)、lifespan 中自动建表 |
| `app/config.py` | Pydantic Settings 配置管理。读取 `.env`，定义路径 (`UPLOAD_DIR`, `PREVIEW_DIR`, `EXPORT_DIR`)、AI API Key、上传限制 (50MB)、允许的图片格式 |
| `app/database.py` | SQLAlchemy 引擎 (SQLite)、`SessionLocal` 会话工厂、`get_db()` 依赖注入、`create_tables()` 建表函数 |

### 核心模块 `app/core/`

| 文件 | 作用 |
|------|------|
| `color_params.py` | **调色参数标准模型** (Pydantic v2)。定义 6 组参数：`BasicParams`(曝光/对比度/高光/阴影/白色/黑色)、`ColorAdjustParams`(色温/色调/自然饱和度/饱和度)、`ToneCurveParams`(主曲线 + RGB 分通道)、`HSLParams`(8 色相通道)、`SplitToningParams`(高光/阴影分离色调)、`EffectsParams`(清晰度/去雾/暗角/颗粒)。所有参数都有范围校验 |
| `image_ops.py` | **16 种图像调整算法**，全部操作 float32 RGB [0,1] numpy 数组。包含：sRGB↔线性空间转换、RGB↔HSL 转换、曝光(2^EV)、对比度、高光/阴影(亮度加权)、色温(RGB 通道增益)、色调、自然饱和度(选择性)、饱和度、色调曲线(三次样条插值)、HSL 分通道(8 色相范围)、分离色调、清晰度(Unsharp Mask)、去雾(暗通道先验)、暗角(径向渐变)、颗粒(高斯噪声) |
| `prompts.py` | **AI 提示词模板**。4 个模板：`SCENE_ANALYSIS_PROMPT`(场景识别)、`STYLE_OPTIONS_PROMPT`(风格生成)、`PREFERENCE_ANALYSIS_PROMPT`(偏好分析)、`GRADING_SUGGESTION_PROMPT`(调色建议)。每个模板都包含 ColorParams JSON Schema 描述，要求 AI 输出严格 JSON |

### 数据模型 `app/models/`

| 文件 | 表 | 作用 |
|------|-----|------|
| `user.py` | `users` | 用户表 — id, created_at |
| `style.py` | `style_sessions` | 风格发现会话 — 状态 (in_progress / completed) |
| | `style_rounds` | 测试轮次 — 含场景类型、时间、天气、原图路径 |
| | `style_options` | 每轮的调色风格选项 — 含参数 JSON、预览图路径、是否选中 |
| | `user_style_profiles` | AI 分析得出的用户风格档案 — profile_data JSON |
| `grading.py` | `grading_tasks` | 调色任务 — 状态 (uploaded → suggested → tuning → exported) |
| | `grading_suggestions` | AI 生成的调色建议 — 含参数、预览图、是否选中 |
| | `exports` | 导出记录 — 含格式、质量、输出路径 |

### API 请求/响应模型 `app/schemas/`

| 文件 | 作用 |
|------|------|
| `style.py` | 风格 API 的 Pydantic 模型：`CreateSessionRequest`, `SelectStyleRequest`, `StyleSessionResponse`, `StyleRoundResponse`, `StyleOptionResponse`, `UserProfileResponse` |
| `grading.py` | 调色 API 的 Pydantic 模型：`CreateTaskRequest`, `SuggestRequest`, `PreviewRequest`, `ExportRequest`, `SuggestionResponse`, `TaskResponse`, `ExportResponse` |

### API 路由 `app/api/`

| 文件 | 路由前缀 | 主要端点 |
|------|---------|---------|
| `upload.py` | `/api/upload` | `POST /` — 通用图片上传，校验格式和大小 |
| `ai_config.py` | `/api/ai` | `GET /providers` — 列出可用 AI 模型；`PUT /provider` — 切换模型。维护全局 `_current_provider` 状态，提供 `get_current_provider()` 供其他路由使用 |
| `style.py` | `/api/style` | `POST /sessions` — 创建会话；`POST /sessions/{id}/rounds` — 上传图片生成风格选项；`POST /rounds/{id}/select` — 用户选择；`POST /sessions/{id}/analyze` — 分析偏好生成档案；`GET /profiles/{id}` — 获取档案 |
| `grading.py` | `/api/grading` | `POST /tasks` — 创建调色任务；`POST /tasks/{id}/suggest` — AI 生成建议；`POST /suggestions/{id}/select` — 选择建议；`POST /tasks/{id}/preview` — 自定义参数预览；`POST /tasks/{id}/export` — 全分辨率导出；`GET /exports/{id}/download` — 下载 |

### 业务逻辑 `app/services/`

| 文件 | 作用 |
|------|------|
| `ai_provider.py` | **AI 多模型抽象层**。`AIProvider` 抽象基类定义 5 个接口方法 (`analyze_image`, `analyze_scene`, `generate_style_options`, `analyze_preferences`, `generate_grading_suggestions`)。`ClaudeProvider` 用 anthropic SDK 实现多模态调用，`OpenAIProvider` 用 openai SDK 实现。`AIProviderFactory` 工厂模式管理注册/获取。内含 `_extract_json()` 健壮解析函数 (直接解析 → 最长有效 JSON 子串) |
| `style_service.py` | **风格发现业务逻辑**。`StyleService` 管理会话/轮次/选项 CRUD。核心方法：`generate_options_for_round()` (加载图片 → base64 → AI 场景分析 → AI 风格生成 → 生成预览图 → 保存选项)、`analyze_preferences()` (汇总选择 → AI 分析 → 生成用户档案) |
| `grading_service.py` | **调色建议业务逻辑**。`GradingService` 管理任务/建议 CRUD。核心方法：`generate_suggestions()` (加载图片 → 结合用户档案 → AI 建议 → 生成预览)、`select_suggestion()`、`generate_preview()` (自定义参数预览)、`export_image()` (全分辨率导出，支持 JPEG/PNG/TIFF) |
| `image_processor.py` | **图像处理服务**。`ImageProcessor` 封装：`load_image()` (读取 → float32)、`save_image()` (uint8 → PIL 保存)、`generate_preview()` (缩放到 800px 宽)、`apply_params()` (按固定顺序调用 16 个 image_ops 函数链式处理) |

---

## 前端各文件详解

### 入口与全局

| 文件 | 作用 |
|------|------|
| `src/main.tsx` | React 入口，挂载 App 到 DOM |
| `src/App.tsx` | 主应用组件。顶部 Header (应用名 + 后端状态指示灯) + Ant Design Steps 导航条 (4 步)，根据 `currentStep` 切换显示对应页面组件 |
| `src/stores/appStore.ts` | **Zustand 全局状态**：`session` (风格会话)、`profile` (用户档案)、`currentStep` (当前步骤 0-3)、`gradingTask` (调色任务)、`selectedSuggestion` (选中建议)、`finalParams` (微调后参数传给导出) |
| `src/types/index.ts` | **TypeScript 类型定义**：`ColorParams`, `StyleOption`, `StyleRound`, `StyleSession`, `UserProfile`, `GradingSuggestion`, `GradingTask` |
| `src/api/index.ts` | **Axios API 客户端**。三组 API：`styleApi` (会话/轮次/选项/分析)、`gradingApi` (任务/建议/预览/导出/下载)、`uploadApi` (通用上传) |

### 页面组件 `src/components/`

| 文件 | 对应步骤 | 作用 |
|------|---------|------|
| `StyleDiscovery/index.tsx` | 步骤 0 | 风格发现：开始会话 → 上传图片 → 展示 4 个风格选项 (网格布局) → 点击选择 → 重复 3+ 轮 → 分析偏好。Steps 进度条显示轮次，最新轮次在上方 |
| `GradingSuggestion/index.tsx` | 步骤 1 | 调色建议：上传待调色图片 → 自动调用 AI 生成 3 个建议 (含预览) → 卡片展示 → 点击 Compare 打开 Before/After 对比 → 选择建议后进入下一步 |
| `GradingSuggestion/BeforeAfterSlider.tsx` | — | **Before/After 对比滑块**。可拖拽分割线对比原图与调色效果，支持鼠标拖拽和触摸操作 |
| `FineTune/index.tsx` | 步骤 2 | 参数微调面板：左侧预览区 (CSS Filter 即时预览 + 服务端精确预览，自动切换)、右侧参数面板 (Basic/Color/Effects 三组可折叠滑块)、重置按钮。滑块拖动时 CSS 即时反馈，停止后请求服务端精确渲染 |
| `FineTune/ParamSliderGroup.tsx` | — | 可复用的参数滑块组组件。每行显示：标签名 + 滑条 + 当前数值 |
| `Export/index.tsx` | 步骤 3 | 导出面板：格式选择下拉框 (JPEG/PNG/TIFF)、JPEG 质量滑块 (50-100)、导出按钮 → 完成后显示预览 + 下载按钮 + 浏览器查看按钮 + 重新导出 |

### 工具与 Hooks

| 文件 | 作用 |
|------|------|
| `src/utils/canvasPreview.ts` | **CSS Filter 实时预览引擎**。`paramsToCssFilter()` 将调色参数映射为 CSS filter 字符串 (brightness/contrast/saturate/sepia/hue-rotate 近似)。`vignetteGradient()` 用 CSS radial-gradient 模拟暗角效果。注意：这是客户端近似预览，服务端为精确结果 |
| `src/hooks/useDebouncedCallback.ts` | **防抖 Hook**。滑块拖动时客户端 CSS 即时预览，停止 500ms 后才请求服务端精确预览，避免频繁 API 调用 |

---

## 测试覆盖

| 测试文件 | 数量 | 覆盖范围 |
|---------|------|---------|
| `test_phase0.py` | 4 | 健康检查、上传校验、数据库建表 |
| `test_cors.py` | 2 | CORS 预检请求和实际跨域请求 |
| `test_color_params.py` | 6 | 参数模型校验、范围约束、JSON 序列化往返 |
| `test_image_processor.py` | 35 | 每个调色操作的单元测试 + 极端值不崩溃 + 组合参数 + 性能 (<2s) |
| `test_ai_provider.py` | 20 | JSON 提取、工厂模式、Mock Claude/OpenAI、错误处理、API Key 不泄露 |
| `test_api_style.py` | 14 | 风格发现服务层 + API 层完整流程 + 选项多样性验证 |
| `test_api_grading.py` | 8 | 调色建议服务层 + API 层 + 个性化验证 (暖色 vs 冷色档案生成不同建议) |
| `test_export.py` | 6 | JPEG/PNG/TIFF 三种格式导出 + API 导出 + 下载 + 404 |
| `test_e2e.py` | 6 | **完整用户旅程** E2E (风格发现 3 轮 → 分析 → 建议 → 预览 → 导出) + 错误边界 |
| **合计** | **101** | |

---

## 关键设计决策

### 1. 双层预览架构
- **客户端 CSS Filter** (~0ms)：将 exposure/contrast/saturation/temperature 映射为 CSS `brightness()`/`contrast()`/`saturate()`/`sepia()`/`hue-rotate()`，暗角用 `radial-gradient` 叠加层
- **服务端 Pillow/OpenCV** (防抖 500ms)：Pillow + numpy float32 精确计算所有 16 种操作，生成 800px 预览图
- 滑块拖动时 CSS 即时反馈，停止后自动切换为服务端精确结果

### 2. AI 多模型抽象
- 工厂模式 (`AIProviderFactory`) + 抽象基类 (`AIProvider`)
- 运行时可通过 API 切换 Claude / OpenAI
- `_extract_json()` 健壮解析：直接解析 → markdown 代码块提取 → 最长有效 JSON 子串匹配

### 3. 参数标准化
- 统一 `ColorParams` Pydantic 模型贯穿前后端
- AI 提示词模板中包含完整 JSON Schema 描述，确保 AI 输出格式严格符合
- 前端 TypeScript 类型与后端 Pydantic 模型对应

### 4. 图像处理管线
- 16 个操作函数按固定顺序链式应用 (曝光 → 对比度 → 高光/阴影 → 色温 → ... → 暗角 → 颗粒)
- 全部在 float32 [0,1] 色彩空间操作，曝光在线性空间计算
- 预览用缩略图 (800px 宽)，导出用原图全分辨率

### 5. 技术栈选型

| 层 | 技术 | 选型理由 |
|----|------|---------|
| 后端框架 | FastAPI + Uvicorn | 异步支持、自动 OpenAPI 文档、Pydantic 集成 |
| 图像处理 | Pillow + OpenCV + numpy | Pillow 做 IO，OpenCV 做高级操作，numpy 做像素级计算 |
| 数据库 | SQLAlchemy + SQLite | 轻量无需额外服务，ORM 便于模型管理 |
| AI | anthropic + openai SDK | 官方 SDK，多模态图像分析 |
| 前端框架 | React 18 + TypeScript + Vite | 类型安全、快速构建 |
| UI 库 | Ant Design | 丰富的组件 (Slider、Steps、Card、Upload、Collapse) |
| 状态管理 | Zustand | 轻量，API 简洁，无 boilerplate |
| HTTP | Axios | 拦截器支持、FormData 处理方便 |
